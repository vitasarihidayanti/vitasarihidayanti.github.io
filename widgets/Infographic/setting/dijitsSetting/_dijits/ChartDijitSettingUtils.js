// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/_base/declare","dojo/_base/lang","jimu/utils","../../utils"],function(w,g,q,p){return w(null,{oidFieldType:"esriFieldTypeOID",stringFieldType:"esriFieldTypeString",numberFieldTypes:["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_customColorDefaultNum:5,dateFieldType:"esriFieldTypeDate",constructor:function(a){a&&g.mixin(this,a);this.others=[{text:this.nls.nullText,label:this.nls.nullText,id:"null",color:"#808080"},{text:this.nls.others,
label:this.nls.others,id:"others",color:"#808080"}];this.colors&&(this.customColors=g.clone(this.colors))},setDataSource:function(a){a&&(this.dataSource=a)},setLayerDefinition:function(a){a&&(this.definition=a)},setPreModle:function(a){this.PRE_MODLE=a},setCustomColor:function(a){this.customColors=g.clone(a)},setFeatures:function(a){this.features=a},getInitializationModle:function(a){return g.clone({config:a,computed:{sortComputed:null,definition:null,showDateOption:"",showUseLayerSymbology:!1,valueFieldsAsMultipleMode:!0,
seriesStyleComputed:null,legendDisplay:!0}})},getInitConfig:function(a,b,c){a=this._getInitDataConfig(a,b&&b.type,c);b=this._getInitDisplayConfig(b);return g.mixin(a,b)},getRandomCustomColor:function(){var a;a=0;if(this._lastCustomColor){var b=this.customColors.indexOf(this._lastCustomColor);-1<b&&(a=b+1,a>this.customColors.length-1&&(a=0))}return this._lastCustomColor=a=this.customColors[a]},updateModleComputed:function(a){var b=a.computed,c=a.config;b.sortComputed=this._calcuteSortComputed(a);b.showUseLayerSymbology=
this._shouldShowUseLayerSymbolDisplay(a);b.showDateOption=this._shouldShowDateOption(a);b.seriesStyleComputed=this._calcuteSeriesStyleComputed(a);b.valueFieldsAsMultipleMode=this._calcuteValueFieldsMode(c);b.legendDisplay=this._calcuteLegendDisplay(c)},dynamicUpdateConfig:function(a,b){var c=a.config;a=a.computed;this._dynamicUpdateDateConfig(c,a);this._dynamicUpdateSeriesStyle(c,a,b)},hasNumberFields:function(a){var b=!1;(a=a.fields)&&0<a.length&&(b=a.some(g.hitch(this,function(a){return 0<=this.numberFieldTypes.indexOf(a.type)})));
return b},getClusterFieldOptions:function(a,b){var c=[this.stringFieldType,this.dateFieldType,this.oidFieldType],c=c.concat(g.clone(this.numberFieldTypes));a=a.filter(g.hitch(this,function(a){return 0<=c.indexOf(a.type)})).map(g.hitch(this,function(a){return{label:a.alias||a.name,value:a.name}}));b&&(a=a.filter(function(a){return a.value===b}));return a},getValueFieldOptions:function(a,b,c){a=a.filter(g.hitch(this,function(a){return 0<=this.numberFieldTypes.indexOf(a.type)}));if(b&&c){var d=c.map(function(a){return a.value});
a=a.filter(function(a){return 0>d.indexOf(a.name)})}return a},isDSEqual:function(a,b){if(a&&b)return a=this._cloneAndFormatDS(a),b=this._cloneAndFormatDS(b),p.isEqual(a,b)},_calcuteSortComputed:function(a){var b={},c=a.config,d=c.sortOrder,c=c.mode,e=this.PRE_MODLE.config.mode;b.mode=c;a=this._getSortFields(a);b.fieldOption=a;!p.isEqual(c,e)&&e?b.sortArrowPosition="feature"===c?"down":"top":b.sortArrowPosition="feature"===c?"down":d.isLabelAxis?"top":"mid";return b},_shouldShowUseLayerSymbolDisplay:function(a){var b=
this.definition,c=!1,d=a.config.mode;if("line"===a.config.type||"field"===d)return c;var e,k=null,f=null;this.dataSource&&(f=this.dataSource,f.layerId?e=f.layerId:f.frameWorkDsId&&(f=p.parseDataSourceId(f.frameWorkDsId))&&"undefined"!==f.layerId&&(e=f.layerId));e&&(k=this._getFeatureLayer(e));if(!e)return c;if("feature"===d)c=!0;else if("category"===d||"count"===d){a=a.config.categoryField;if(!k)return c;k.renderer&&(k=k.renderer,"esri.renderer.ClassBreaksRenderer"===k.declaredClass||"esri.renderer.UniqueValueRenderer"===
k.declaredClass)&&(k.attributeField!==a||p.isDateField(a,b)||(c=!0))}return c},_shouldShowDateOption:function(a){var b=p.isDateField(a.config.categoryField,this.definition);a=a.config.mode;return("category"===a||"count"===a)&&b},_calcuteValueFieldsMode:function(a){var b=a.mode,c=!0;("feature"===b||"category"===b)&&a&&"pie"===a.type&&(c=!1);!c&&a.valueFields&&1<a.valueFields.length&&(a.valueFields=a.valueFields.slice(0,1));return c},_calcuteLegendDisplay:function(a){var b=a.mode,c;"pie"===a.type?c=
!0:(c=!0,"count"===b||"field"===b?c=!1:a.seriesStyle&&(c="layerSymbol"!==a.seriesStyle.type));return c},_calcuteSeriesStyleComputed:function(a){var b=a.config,c=b.mode,d=b.type,e=b.area,k=b.valueFields||[],f=b.categoryField,g=this.definition,l={},h="single",u=!0,n="none",h=[];a.computed.showUseLayerSymbology&&h.push("layerSymbol");"pie"!==d||"category"!==c&&"count"!==c||p.isDateField(f,g)||h.push("custom");2===h.length&&(n="all");1===h.length&&(n=h[0]);h=1<k.length?"multiply":"single";"line"===d&&
"field"===c&&(h="single");"pie"===d&&(u="field"===c);a="";if("category"===c||"count"===c)a=b.categoryField;l.colorSingleMode=u;l.colorDisplayMode=h;l.showOpacity=!!e;l.otherRadio=n;l.categoryField=a;if("custom"===n||"all"===n)b=p.isNumberType(f,g,!0),f=q.getCodedValueListForCodedValueOrSubTypes(g,f),l.categoryTypes={isNumberType:b,isCodedValueType:!!f},l.customColorSelects=this._getCustomColorSelects(a,g);l.chartType=d;return l},_createSeriesStyle:function(a,b,c){a={name:a,style:{color:this._getRandomColor()}};
b&&(a.style.opacity=6);c&&(a.style.color="#68D2E0 #087E92 #47BCF5 #FBE66A #F29157 #C8501D".split(" "));return a},_dynamicUpdateDateConfig:function(a,b){b.showDateOption?a.dateConfig||(a.dateConfig={isNeedFilled:!0,minPeriod:"automatic"}):a.dateConfig=null},_dynamicUpdateSeriesStyle:function(a,b,c){var d=a.mode,e=a.type,k=a.area,f=a.categoryField,m=a.valueFields||[],l=this.definition,h=g.clone(a.seriesStyle);h||(h={});var q=!1;"line"===e&&k&&(q=!0);b=b.showUseLayerSymbology;"undefined"===typeof h.type&&
(h.type="series");b||"layerSymbol"!==h.type||(h.type="series");"field"===d&&(h.type="series");"feature"===d&&"custom"===h.type&&(h.type="series");f&&p.isDateField(f,l)&&"custom"===h.type&&(h.type="series");var f=h.styles||[],n=[],r=[];b=[];n=f.map(function(a){return a.name});r=n.filter(function(a){return 0>m.indexOf(a)});b=m.filter(function(a){return 0>n.indexOf(a)});var v=!1;"column"===e||"bar"===e||"line"===e?"line"===e&&"field"===d?"line~field"===n[0]?(r=[],b=[]):(r=n,b=["line~field"]):"count"===
d&&("count~count"===n[0]?(r=[],b=[]):(r=n,b=["count~count"])):"pie"===e&&"field"!==d&&("pie~not-field"===n[0]?(r=[],b=[]):(v=!0,r=n,b=["pie~not-field"]));f=f.filter(function(a){return 0>r.indexOf(a.name)});d=b.map(function(a){return this._createSeriesStyle(a,q,v)}.bind(this));f=f.concat(d);h.styles=null;h.styles=f;f.forEach(function(a){-1<m.indexOf(a.name)?a.label=p.getFieldAlias(a.name,l,this.popupInfo):a.label=a.name}.bind(this));this._dynamicUpdateSeriesStyleCustomColor(h,a,c)},_dynamicUpdateSeriesStyleCustomColor:function(a,
b,c){var d=this.dataSource,e=this.definition,k=b.categoryField,f=this.PRE_MODLE.config;c="pie"!==b.type||"category"!==b.mode&&"count"!==b.mode?"remove":a.customColor?c?"keep":k===f.categoryField?"keep":"update":"update";f=null;"remove"===c?"undefined"!==typeof a.customColor&&delete a.customColor:"update"===c&&d&&k&&(f=this._getCustomColorCategories(k,e),a.customColor||(a.customColor={}),f&&(a.customColor.categories=f),a.customColor.others&&a.customColor.others.length||(a.customColor.others=g.clone(this.others)));
b&&(b.seriesStyle=a)},_getCustomColorSelects:function(a,b){var c=this._getCategoriesByFeatures(a);if(c&&c.length){var c=c.filter(function(a){return!!a||0===a}),d=[];return d=(a=q.getCodedValueListForCodedValueOrSubTypes(b,a))?g.clone(a):c.map(function(a){return{label:a,value:a}})}},_getCustomColorCategories:function(a,b){var c=this._getCategoriesByFeatures(a);if(c&&c.length){c=c.filter(function(a){return!!a||0===a});c.length>this._customColorDefaultNum&&(c=c.slice(0,this._customColorDefaultNum));
var d;return c.map(function(c){var e={};e[a]=c;e=q.getDisplayValueForCodedValueOrSubtype(b,a,e);d=e.isCodedValueOrSubtype?e.displayValue:c;return{id:c,text:d,label:d,color:this.getRandomCustomColor()}}.bind(this))}},_getCategoriesByFeatures:function(a){var b=[];if(!this.features||!this.features.length)return b;this.features.forEach(g.hitch(this,function(c){c=c.attributes[a];0>b.indexOf(c)&&b.push(c)}));return this._sortOrderCategories(b)},_getSortFields:function(a){if(a){var b=this.definition;a=a.config;
var c=a.mode;if(b&&a&&("feature"===c||a.valueFields&&a.valueFields[0])){var d=[];"feature"===c?(d=g.clone(b.fields),d=p.getNotGeometryFields(d)):a.valueFields&&(d=p.getFieldInfosByFieldName(a.valueFields,this.definition));return d.map(function(a){return{value:a.name,label:a.alias||a.name}})}}},_cloneAndFormatDS:function(a){a=g.clone(a);var b={};a.name&&(b.name=a.name);a.dataSourceType&&(b.dataSourceType=a.dataSourceType);a.layerId&&(b.layerId=a.layerId);a.frameWorkDsId&&(b.frameWorkDsId=a.frameWorkDsId);
a=null;return b},_sortOrderCategories:function(a){Array.isArray(a)&&a.sort(function(a,c){"string"===typeof s&&(a=a.toLowerCase());"string"===typeof t&&(c=c.toLowerCase());q.isNumberOrNumberString(a)&&(a=Number(a));q.isNumberOrNumberString(c)&&(c=Number(c));return a<c?-1:a>c?1:0}.bind(this));return a},_getDominDisplayValue:function(a,b,c){var d=b;(a=p.getFieldInfo(a,c))&&a.domain&&(a=a.domain.codedValues)&&0<a.length&&a.some(function(a){return a.code===b?(d=a.name,!0):!1});return d},_getRandomColor:function(){var a;
a=0;if(this._lastColor){var b=this.colors.indexOf(this._lastColor);-1<b&&(a=b+1,a>this.colors.length-1&&(a=0))}return this._lastColor=a=this.colors[a]},_getFeatureLayer:function(a){var b=null;this.map&&"undefined"!==typeof a&&(b=this.map.getLayer(a));return b},_getInitDisplayConfig:function(a){var b,c,d,e;a&&(b=a.type,c=a.area,d=a.stack,e=a.innerRadius);a=this.getDefaultColorOfTheme();var k=a.textColor,f=a.bgColor,m={};a=["backgroundColor","seriesStyle","legend","highLightColor"];switch(b){case "column":case "bar":case "line":a=
a.concat(["xAxis","yAxis","stack","area","marks"]);break;case "pie":a=a.concat(["dataLabel","innerRadius"])}var l={color:k,fontSize:12};a.forEach(function(a){switch(a){case "backgroundColor":m.backgroundColor=f;break;case "seriesStyle":m.seriesStyle={styles:[]};break;case "legend":m.legend={show:!1,textStyle:g.clone(l)};break;case "highLightColor":m.highLightColor=void 0;break;case "xAxis":m.xAxis={show:!0,textStyle:g.clone(l),nameTextStyle:{color:k}};break;case "yAxis":m.yAxis={show:!0,textStyle:g.clone(l),
nameTextStyle:{color:k}};break;case "dataLabel":m.dataLabel={show:!1,textStyle:g.clone(l)};break;case "innerRadius":m.innerRadius=e;break;case "stack":m.stack=d;break;case "area":m.area=c;break;case "marks":m.marks={}}}.bind(this));return m},_getInitDataConfig:function(a,b,c){var d={mode:a,type:b},e=["sortOrder","maxLabels"];switch(a){case "feature":e.push("labelField","valueFields");break;case "count":e.push("categoryField");break;case "category":e.push("categoryField","valueFields","operation",
"nullValue");break;case "field":e=e.concat(["operation","nullValue","valueFields"])}"category"!==a&&"count"!==a||!p.isDateField(c,this.definition)||e.push("dateConfig");e.forEach(function(e){switch(e){case "labelField":d.labelField=c;break;case "categoryField":d.categoryField=c;break;case "valueFields":d.valueFields=[];break;case "sortOrder":d.sortOrder=this._getInitSortOrderByMode(a);break;case "operation":d.operation="sum";break;case "nullValue":d.nullValue=!0;break;case "dateConfig":d.dateConfig=
this._getInitDateConfigByType(b);break;case "maxLabels":d.maxLabels="pie"===b?100:""}}.bind(this));return d},_getInitDateConfigByType:function(a){},_getInitSortOrderByMode:function(a){var b={isAsc:!0};"feature"===a?(a=this._getFieldsByDefinition())&&a[0]&&(b.field=a[0].value):b.isLabelAxis=!0;return b},_getFieldsByDefinition:function(a){if(a=a||this.definition)return g.clone(a.fields)},getDefaultColorOfTheme:function(){var a={bgColor:"#fff",textColor:"#000"};if(!this.appConfig)return a;"DashboardTheme"!==
this.appConfig.theme.name||"default"!==this.appConfig.theme.styles[0]&&"style3"!==this.appConfig.theme.styles[0]?"DartTheme"===this.appConfig.theme.name&&(a.bgColor="#4c4c4c",a.textColor="#fff"):(a.bgColor="#222222",a.textColor="#fff");return a}})});