// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/Deferred","dojo/_base/lang","esri/request","jimu/utils"],function(f,e,g,h){return{_cacheDefinition:{},getLayerDefinitionByLayerIdOrUrl:function(a,b){var c=new f,d=this._cacheDefinition[a]||this._cacheDefinition[b];if(d)return c.resolve(d),c;if(!a)return g({url:b,hanleAs:"json",content:{f:"json"},callbackParamName:"callback"}).then(function(a){this._cacheDefinition[b]=a;c.resolve(a)}.bind(this),function(a){c.reject(a)}),c;var d=this.layerInfosObj.getLayerInfoById(a),e=d.getPopupInfo();
d?this._getServiceDefinitionByLayerInfo(d).then(function(b){this._addAliasForLayerDefinition(b,e);this._cacheDefinition[a]=b;c.resolve(b)}.bind(this)):c.reject("Invaild layerInfo for layer id: "+a);return c},_getServiceDefinitionByLayerInfo:function(a){return a.getServiceDefinition().then(e.hitch(this,function(b){return b?b:a.getLayerObject().then(e.hitch(this,function(a){return a?h.getFeatureLayerDefinition(a):null}))}))},_addAliasForLayerDefinition:function(a,b){a&&a.fields&&0<a.fields.length&&
a.fields.forEach(e.hitch(this,function(a){var c=this.getFieldAliasByFieldInfo(a,b);c&&(a.alias=c)}))},getFieldAliasByFieldInfo:function(a,b){var c="";if(!a)return c;var d=a.name,c=a.alias||d;b&&(c=this.getAliasFromPopupInfo(d,b));return c},getAliasFromPopupInfo:function(a,b){var c=a;if(!b)return c;(b=b.fieldInfos)&&0<b.length&&b.forEach(function(b){b.fieldName===a&&(c=b.label)});return c}}});